<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabyasachi | Manpower Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --sab-black: #000000; --sab-white: #ffffff; --sab-gold: #AD9651; --sab-gray: #F8F8F8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--sab-white); color: var(--sab-black); line-height: 1.4; }

        /* Login */
        #loginScreen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--sab-black); color: white; }
        .brand-logo { font-family: 'Playfair Display', serif; font-size: 3.5rem; letter-spacing: 12px; margin-bottom: 30px; }
        .login-form input { width: 300px; background: transparent; border: none; border-bottom: 1px solid var(--sab-gold); color: white; padding: 12px; margin-bottom: 20px; outline: none; text-align: center; }
        .login-btn { width: 300px; padding: 15px; background: var(--sab-gold); color: black; border: none; font-weight: 600; cursor: pointer; letter-spacing: 2px; }

        /* Dashboard */
        #mainDashboard { display: none; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 15px; }
        .header h2 { font-family: 'Playfair Display', serif; letter-spacing: 4px; font-size: 1.8rem; }
        
        .status-bar { display: flex; justify-content: flex-end; gap: 20px; font-size: 0.65rem; padding: 10px 0; color: #666; }
        #successTag { color: var(--sab-gold); font-weight: bold; display: none; }

        /* Multi-Select Filters */
        .filter-bar { display: flex; gap: 10px; background: var(--sab-gray); padding: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.6rem; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        select[multiple] { height: 35px; min-width: 140px; font-size: 0.75rem; border: 1px solid #ddd; outline: none; }
        .date-input { padding: 8px; border: 1px solid #ddd; font-size: 0.75rem; }

        /* KPI Tiles */
        .kpi-row { display: flex; gap: 1px; background: black; border: 1px solid black; margin-bottom: 30px; }
        .kpi-tile { flex: 1; background: white; padding: 20px 10px; text-align: center; }
        .kpi-tile label { display: block; font-size: 0.6rem; letter-spacing: 1px; color: #888; text-transform: uppercase; margin-bottom: 8px; }
        .kpi-tile .value { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; }

        /* Content Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .card { background: white; border: 1px solid #eee; padding: 15px; }
        .card h4 { font-size: 0.7rem; border-bottom: 1px solid black; padding-bottom: 5px; margin-bottom: 10px; letter-spacing: 1px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { text-align: left; padding: 5px 0; color: #888; font-weight: 400; }
        td { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }

        /* Graph Section */
        .graph-section { background: white; border: 1px solid #eee; padding: 25px; margin-top: 20px; position: relative; }
        .graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: var(--sab-black); color: white; border: none; padding: 5px 15px; font-size: 0.7rem; cursor: pointer; display: none; }

        .upload-btn { color: var(--sab-gold); font-size: 0.75rem; cursor: pointer; text-decoration: underline; font-weight: 600; margin-right: 15px; }
        .logout-btn { border: 1px solid black; padding: 5px 12px; font-size: 0.7rem; cursor: pointer; background: white; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1 class="brand-logo">SABYASACHI</h1>
        <form id="loginForm" class="login-form">
            <input type="email" id="email" placeholder="ADMIN EMAIL" required>
            <input type="password" id="password" placeholder="PASSWORD" required>
            <button type="submit" class="login-btn">ENTER DASHBOARD</button>
        </form>
    </div>

    <div id="mainDashboard">
        <div class="status-bar">
            <span id="successTag">✓ SYNC SUCCESSFUL</span>
            <span id="lastUpdateText">Last Updated: Never</span>
        </div>
        
        <header class="header">
            <h2>SABYASACHI</h2>
            <div>
                <span id="adminControls" style="display:none">
                    <label class="upload-btn" for="fileInput">UPLOAD MASTER</label>
                    <input type="file" id="fileInput" style="display:none" onchange="handleExcel(event)">
                </span>
                <button class="logout-btn" onclick="location.reload()">LOGOUT</button>
            </div>
        </header>

        <div class="filter-bar">
            <div class="filter-group"><label>Cohort</label><select id="cohortFilter" multiple onchange="calculate()"></select></div>
            <div class="filter-group"><label>Dept</label><select id="deptFilter" multiple onchange="calculate()"></select></div>
            <div class="filter-group"><label>Type</label><select id="typeFilter" multiple onchange="calculate()"></select></div>
            <div class="filter-group"><label>Level</label><select id="levelFilter" multiple onchange="calculate()"></select></div>
            <div class="filter-group"><label>FY Start</label><input type="date" id="startDate" class="date-input" onchange="calculate()"></div>
            <div class="filter-group"><label>Analysis Date</label><input type="date" id="endDate" class="date-input" onchange="calculate()"></div>
        </div>

        <div class="kpi-row">
            <div class="kpi-tile"><label>Current HC</label><div id="hc-active" class="value">0</div></div>
            <div class="kpi-tile"><label>Planned</label><div id="hc-planned" class="value">0</div></div>
            <div class="kpi-tile"><label>Monthly Cost</label><div id="cost-monthly" class="value">₹0</div></div>
            <div class="kpi-tile"><label>YTD Cost</label><div id="cost-ytd" class="value">₹0</div></div>
            <div class="kpi-tile"><label>Annual Projection</label><div id="cost-annual" class="value">₹0</div></div>
        </div>

        <div class="grid">
            <div class="card"><h4>BY COHORT</h4><table id="cohortTable"><thead><tr><th>Cohort</th><th>HC</th><th>YTD Cost</th></tr></thead><tbody></tbody></table></div>
            <div class="card"><h4>BY TYPE</h4><table id="typeTable"><thead><tr><th>Type</th><th>HC</th><th>YTD Cost</th></tr></thead><tbody></tbody></table></div>
            <div class="card"><h4>BY LEVEL</h4><table id="levelTable"><thead><tr><th>Level</th><th>HC</th><th>YTD Cost</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div class="graph-section">
            <div class="graph-header">
                <h3 id="chartTitle" style="font-family: 'Playfair Display'; letter-spacing: 2px;">FY COST YEAR-ON-YEAR</h3>
                <button id="backBtn" class="back-btn" onclick="resetChart()">← BACK TO YOY</button>
            </div>
            <div style="height: 300px;"><canvas id="mainChart"></canvas></div>
        </div>
    </div>

    <script>
        let DATA = [];
        let mainChart = null;

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            if (email === 'admin@sabyasachi.com' && document.getElementById('password').value === 'admin123') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('adminControls').style.display = 'inline';
                setInitDates();
            } else { alert("Access Denied"); }
        });

        function setInitDates() {
            const now = new Date();
            const startYear = now.getMonth() < 3 ? now.getFullYear() - 1 : now.getFullYear();
            document.getElementById('startDate').value = `${startYear}-04-01`;
            document.getElementById('endDate').valueAsDate = now;
        }

        function handleExcel(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const workbook = XLSX.read(event.target.result, { type: 'binary' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                DATA = json.map(row => ({
                    code: row['Employee Code'], cohort: row['Cohort'], dept: row['Department'],
                    type: row['Employee Type'], level: row['Level'],
                    doj: parseExcelDate(row['Date of Joining']),
                    dol: row['Date of Leaving'] ? parseExcelDate(row['Date of Leaving']) : null,
                    ctc: parseFloat(String(row['Annual CTC']).replace(/,/g, '')) || 0,
                    status: row['Status']
                }));
                populateFilters();
                calculate();
                updateYoYChart();
                showSuccess();
            };
            reader.readAsBinaryString(e.target.files[0]);
        }

        function parseExcelDate(val) {
            let date = new Date(val);
            if (!isNaN(date)) return date;
            return new Date(1900, 0, val - 1);
        }

        function populateFilters() {
            const fill = (id, key) => {
                const vals = [...new Set(DATA.map(d => d[key]))].sort();
                document.getElementById(id).innerHTML = vals.map(v => `<option value="${v}" selected>${v}</option>`).join('');
            };
            fill('cohortFilter', 'cohort'); fill('deptFilter', 'dept'); fill('typeFilter', 'type'); fill('levelFilter', 'level');
        }

        function calculate() {
            const end = new Date(document.getElementById('endDate').value);
            const startFY = new Date(document.getElementById('startDate').value);
            
            const selCohorts = Array.from(document.getElementById('cohortFilter').selectedOptions).map(o => o.value);
            const selDepts = Array.from(document.getElementById('deptFilter').selectedOptions).map(o => o.value);
            const selTypes = Array.from(document.getElementById('typeFilter').selectedOptions).map(o => o.value);
            const selLevels = Array.from(document.getElementById('levelFilter').selectedOptions).map(o => o.value);

            let filtered = DATA.filter(d => selCohorts.includes(d.cohort) && selDepts.includes(d.dept) && selTypes.includes(d.type) && selLevels.includes(d.level));

            let mCost = 0, ytdCost = 0, activeHC = 0, vacancyHC = 0;

            filtered.forEach(emp => {
                const doj = emp.doj, dol = emp.dol || new Date(2099, 11, 31);
                
                // Monthly Cost (Pro-rata)
                mCost += getMonthCost(emp, end.getFullYear(), end.getMonth());
                
                if (doj <= end && dol >= end && emp.status === 'Active') activeHC++;
                if (emp.status.toLowerCase().includes('vacancy') || emp.status.toLowerCase().includes('planned')) vacancyHC++;

                // YTD (Loop months from FY Start to End Date)
                let runner = new Date(startFY);
                while (runner <= end) {
                    ytdCost += getMonthCost(emp, runner.getFullYear(), runner.getMonth());
                    runner.setMonth(runner.getMonth() + 1);
                }
            });

            // Projection
            const fyEnd = new Date(startFY.getFullYear() + 1, 2, 31);
            const monthsLeft = (fyEnd.getFullYear() - end.getFullYear()) * 12 + (fyEnd.getMonth() - end.getMonth());
            const annualProjected = ytdCost + (mCost * monthsLeft);

            document.getElementById('hc-active').innerText = activeHC;
            document.getElementById('hc-planned').innerText = vacancyHC;
            document.getElementById('cost-monthly').innerText = fmt(mCost);
            document.getElementById('cost-ytd').innerText = fmt(ytdCost);
            document.getElementById('cost-annual').innerText = fmt(annualProjected);

            updateBreakdownTable('cohortTable', filtered, 'cohort', startFY, end);
            updateBreakdownTable('typeTable', filtered, 'type', startFY, end);
            updateBreakdownTable('levelTable', filtered, 'level', startFY, end);
        }

        function getMonthCost(emp, year, month) {
            const mStart = new Date(year, month, 1);
            const mEnd = new Date(year, month + 1, 0);
            const totalDays = mEnd.getDate();
            const overlapStart = emp.doj > mStart ? emp.doj : mStart;
            const overlapEnd = (emp.dol && emp.dol < mEnd) ? emp.dol : mEnd;

            if (overlapStart <= mEnd && overlapEnd >= mStart) {
                const activeDays = Math.max(0, (overlapEnd - overlapStart) / (1000 * 60 * 60 * 24) + 1);
                return (emp.ctc / 12) * (activeDays / totalDays);
            }
            return 0;
        }

        function updateBreakdownTable(tableId, filtered, key, fyStart, end) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            const groups = [...new Set(filtered.map(d => d[key]))];
            groups.forEach(g => {
                const subset = filtered.filter(d => d[key] === g);
                let gYTD = 0;
                subset.forEach(e => {
                    let r = new Date(fyStart);
                    while(r <= end) { gYTD += getMonthCost(e, r.getFullYear(), r.getMonth()); r.setMonth(r.getMonth()+1); }
                });
                tbody.innerHTML += `<tr><td>${g}</td><td>${subset.length}</td><td>${fmt(gYTD)}</td></tr>`;
            });
        }

        function updateYoYChart() {
            const years = [2022, 2023, 2024, 2025];
            const dataset = years.map(y => {
                let total = 0;
                const fyS = new Date(y, 3, 1), fyE = new Date(y+1, 2, 31);
                DATA.forEach(e => {
                    let r = new Date(fyS);
                    while(r <= fyE) { total += getMonthCost(e, r.getFullYear(), r.getMonth()); r.setMonth(r.getMonth()+1); }
                });
                return total;
            });

            if(mainChart) mainChart.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['FY 22-23', 'FY 23-24', 'FY 24-25', 'FY 25-26'], datasets: [{ data: dataset, backgroundColor: '#000' }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => { if(elements.length > 0) drillDown(years[elements[0].index]); },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function drillDown(year) {
            document.getElementById('chartTitle').innerText = `DEPT BREAKDOWN: FY ${year}-${(year+1).toString().slice(-2)}`;
            document.getElementById('backBtn').style.display = 'block';
            
            const depts = [...new Set(DATA.map(d => d.dept))];
            const fyS = new Date(year, 3, 1), fyE = new Date(year+1, 2, 31);
            const data = depts.map(d => {
                let t = 0;
                DATA.filter(e => e.dept === d).forEach(e => {
                    let r = new Date(fyS); while(r <= fyE) { t += getMonthCost(e, r.getFullYear(), r.getMonth()); r.setMonth(r.getMonth()+1); }
                });
                return t;
            });

            mainChart.data.labels = depts;
            mainChart.data.datasets[0].data = data;
            mainChart.data.datasets[0].backgroundColor = '#AD9651';
            mainChart.update();
        }

        function resetChart() {
            document.getElementById('chartTitle').innerText = 'FY COST YEAR-ON-YEAR';
            document.getElementById('backBtn').style.display = 'none';
            updateYoYChart();
        }

        function fmt(n) { 
            if (n >= 10000000) return "₹" + (n/10000000).toFixed(2) + " Cr"; 
            if (n >= 100000) return "₹" + (n/100000).toFixed(2) + " L";
            return "₹" + Math.round(n).toLocaleString('en-IN'); 
        }

        function showSuccess() {
            document.getElementById('successTag').style.display = 'inline';
            document.getElementById('lastUpdateText').innerText = "Last Updated: " + new Date().toLocaleTimeString();
            setTimeout(() => document.getElementById('successTag').style.display = 'none', 4000);
        }
    </script>
</body>
</html>
